<!DOCTYPE html>
<html>

<head>
    <title>List</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous">
    </script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous">
    </script>
    <link rel="stylesheet" href="/css/toolistyle.css">

    <script>
        $(document).ready(function () {
            var newEntryName, deleteEntryID;

            $('.ajaxForm').submit(function (e) {
                e.preventDefault();
                $.post($(this).attr('action'), $(this).serialize());
                $(this).find('.clearOnSubmit').val('');
            });
        });
    </script>
</head>

<body>
    <div class="theader">
        <div class="tnavbar">
            <nav class="tnavLinks">
                <a href="/logout">Logout</a>
                <a class="acc" href="/acc/<%=account.id%>"><%=account.name%></a>
            </nav>
        </div>
    </div>
    <a class="toolilogolink" href="#">
        <img src="/_testbild.png" alt="Logo" class="toolilogo">
    </a>

    <div class="twrapper">
        <div class="tside">
            <div class="tsidebar">
                <div class="tsidetop">
                    <div class="tsidetopcontent">
                        <a href="/new-list" style="position: fixed"> New List</a>
                    </div>
                </div>
                <ul id="lists">
                    <% resList.forEach(function(list){ %>
                    <li id="listsItem">
                        <a href="/list/<%= list.id %>"><%= list.name %></a>
                        <form method="POST" action="/deleteList">
                            <input type="hidden" name="deleteListId" value="<%=list.id%>" />
                            <input type="submit" value="X"></input>
                        </form>
                    </li>
                    <% }) %>
                </ul>
            </div>
        </div>
        <div class="row d-flex justify-content-center tcontent">
            <div class="col-md-6">
                <h1>List</h1>
                <div id="entries">
                    <% resEntry.forEach(function(entry){ %>
                    <div id="entryItem" class="entryitem">
                        <input id="entryCheck<%=entry.id%>" class="entryCheck" value="<%=entry.id%>" type="checkbox"
                            <% if (entry.status>0) { %> checked <% } %>></input>
                        <span><%= entry.name %></span>
                        <form method="POST" action="/deleteEntry">
                            <input type="hidden" name="deleteEntryId" value="<%=entry.id%>" />
                            <input type="submit" value="X"></input>
                        </form>
                    </div>
                    <% }) %>
                </div>
                <form action="" class="" method="post">
                    <input type="text" name="newEntryName" id="newEntryName" class="" placeholder="Neuer Eintrag" />
                    <input type="submit" id="newEntrySub" value="ok">
                </form>
                <form method="POST" action="/addUserToList">
                    <input type="text" name="addUserName" value="" placeholder="Username" />
                    <input type="submit" value="Add"></input>
                </form>
                <form method="POST" action="/removeUserFromList">
                    <input type="hidden" name="accountId" value="<%=account.id%>" />
                    <input type="submit" value="Leave"></input>
                </form>
            </div>
        </div>
    </div>
    <div class="chatarea">
        <ul class="chatitems">
            <% resChat.forEach(function(Chat){ %>
            <li class="chatitem">
                <%=Chat.senderName%> &#58; <%=Chat.message%>
                <form method="POST" action="/deleteChat">
                    <input type="hidden" name="deleteChatId" value="<%=Chat.id%>" />
                    <input type="submit" value="X"></input>
                </form>
            </li>
            <% }) %>
        </ul>
        <form id="chatform" class="chatform ajaxForm" action="/chat">
            <button class="chatbutton">Send</button>
            <div class="chatinputbox">
                <input id="chatmessage" name="chatmessage" class="chatinputtext clearOnSubmit" autocomplete="off" />
                <input type="hidden" id="accountid" value="<%=account.id%>" />
            </div>
        </form>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        $(document).ready(function () {
            const listNsp = io('/listNsp');
            const globalSkt = io();
            listNsp.emit('joinRoom', {
                rid: 'L' + window.location.href.substr(window.location.href.lastIndexOf('/') + 1)
            });
            //Status Change
            $('.entryCheck').change(function (e) {
                //e.preventDefault(); // prevents page reloading
                var status = 0;
                if (this.checked)
                    status = 1;
                listNsp.emit('checkEntryChange', {
                    id: e.target.getAttribute("value"),
                    st: status
                });
                return false;
            });
            listNsp.on('checkEntryChange', function (msg) {
                var checked = true;
                if (msg.st == 0)
                    checked = false;
                $('#entryCheck' + msg.id).prop('checked', checked);
            });
            listNsp.on('chatMessage', function (msg) {
                var $newli = '<li class="chatitem">' + msg.sender + ' : ' + msg.message +
                    '<form method="POST" action="/deleteChat"><input type="hidden" name="deleteChatId" value="' +
                    msg.id + '"><input type="submit" value="X"></form></li>';
                $('.chatitems').append($newli); //TODO fix this
            });
            globalSkt.on('newsMessage', function (msg) {
                //news go here
            });
        });
    </script>

</body>

</html>