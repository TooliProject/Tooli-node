<!DOCTYPE html>
<html>

<head>
    <title>List</title>
    <%- include ejs/scriptsAndStyle.ejs %>

    <script>
        $(document).ready(function () {
            var newEntryName, deleteEntryID;

            $('.ajaxForm').submit(function (e) {
                e.preventDefault();
                $.post($(this).attr('action'), $(this).serialize());
                $(this).find('.clearOnSubmit').val('');
            });
            $('#toggleSidebar').click(function (e) {
                e.preventDefault();
                var side = $('.tside');
                if (side.css('width') == '0px') {
                    if ($(window).innerWidth() < 768) {
                        side.css('width', '75%');
                    } else {
                        side.css('width', '');
                    }
                } else {
                    side.css('width', '0%');
                }
            });
            $('#toggleChat').click(function (e) {
                e.preventDefault();
                var chatwrapper = $('.chatwrapper');
                if (chatwrapper.css('right') == '0px') {
                    chatwrapper.css('right', '-300px');
                } else {
                    chatwrapper.css('right', '0px');
                }
            });
            $('#chatform').submit(function (e) {
                $('.chatitems').animate({
                    scrollTop: $('.chatitems').prop('scrollHeight')
                }, 1000);
            });

        });
    </script>
</head>

<body>

    <%- include ejs/navbar.ejs %>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-3">
                <div class="tsidebar">
                    <div class="tsidetop">
                        <div class="tsidetopcontent">
                            <a href="/new-list"> New List</a>
                        </div>
                    </div>
                    <ul id="lists">
                        <% resList.forEach(function(list){ %>
                        <li id="listsItem">
                            <a id="listItemElement<%= list.id %>" href="/list/<%= list.id %>"><%= list.name %></a>
                            <form method="POST" action="/deleteList">
                                <input type="hidden" name="deleteListId" value="<%=list.id%>" />
                                <input type="submit" value="X"></input>
                            </form>
                        </li>
                        <% }) %>
                    </ul>
                </div>
            </div>
            <!-- Content -->
            <div class="col-9">
                <h1>List</h1>

                <div class="row">
                    <div class="col-12">
                        <form action="" class="form-inline" method="post">
                            <div class="form-group">
                                <label for="newEntryName"
                                    class="mr-2">
                                    Add Entry
                                </label>
                                <input type="text"
                                       name="newEntryName"
                                       id="newEntryName"
                                       class="form-control mr-2"
                                       placeholder="Do the dishes" />
                                <input type="submit" class="btn btn-outline-secondary" id="newEntrySub" value="Confirm">
                            </div>


                        </form>
                    </div>
                </div>

                <hr>

                <div class="row">
                    <div class="col-12">
                        <div id="entries">
                            <% resEntry.forEach(function(entry){ %>
                            <div id="entryItem" class="form-group ml-4">
                                <div class="row">
                                    <div class="col-9 mt-2">
                                        <input
                                                id="entryCheck<%=entry.id%>"
                                                class="form-check-input mt-0"
                                                type="checkbox"
                                                value="<%=entry.id%>"
                                        <% if (entry.status>0) { %> checked <% } %>
                                        />
                                        <label for="entryCheck<%=entry.id%>" class="form-check-label">
                                            <%=entry.name%>
                                        </label>
                                    </div>
                                    <div class="col-3">
                                        <form method="POST" action="/deleteEntry">
                                            <input type="submit" class="btn btn-outline-secondary" value="Remove"></input>
                                            <input type="hidden" name="deleteEntryId" value="<%=entry.id%>" />
                                        </form>
                                    </div>
                                </div>

                            </div>
                            <hr>
                            <% }) %>
                        </div>
                    </div>
                </div>
                <div class="row">

                    <form method="POST" action="/addUserToList">
                        <input type="text" name="addUserName" value="" placeholder="Username" />
                        <input type="submit" value="Add"></input>
                    </form>
                    <form method="POST" action="/removeUserFromList">
                        <input type="hidden" name="accountId" value="<%=account.id%>" />
                        <input type="submit" value="Leave"></input>
                    </form>
                    <div id="testForPopup"></div>
                </div>
            </div>
        </div>
    </div>
<!--    <div class="chatwrapper">-->
<!--        <a id="toggleChat" class="toggleChatButton" href=""><img style="width: inherit; height: inherit;"-->
<!--                src="/chatTMP.png" alt=""></a>-->
<!--        <div class="chatarea">-->
<!--            <div class="chatitems">-->
<!--                <% resChat.forEach(function(Chat){ %>-->
<!--                &lt;!&ndash;use template HMMMMM&ndash;&gt;-->
<!--                <div class="chatitem">-->
<!--                    <%=Chat.senderName%> &#58; <%=Chat.message%>-->
<!--                    <form method="POST" class="deleteChatForm ajaxForm" action="/deleteChat">-->
<!--                        <input type="hidden" name="deleteChatId" value="<%=Chat.id%>" />-->
<!--                        <input type="submit" value="X"></input>-->
<!--                    </form>-->
<!--                </div>-->
<!--                <% }) %>-->
<!--            </div>-->
<!--            <form id="chatform" class="chatform ajaxForm" action="/chat">-->
<!--                <button class="chatbutton">Send</button>-->
<!--                <div class="chatinputbox">-->
<!--                    <input id="chatmessage" name="chatmessage" class="chatinputtext clearOnSubmit"-->
<!--                        placeholder="Message List Members..." autocomplete="off" />-->
<!--                    <input type="hidden" id="accountid" value="<%=account.id%>" />-->
<!--                </div>-->
<!--            </form>-->
<!--        </div>-->
<!--    </div>-->
    <%- include ejs/userSocketControl.ejs %>
    <script>
        $(document).ready(function () {
            const listNsp = io('/listNsp');
            const globalSkt = io();
            listNsp.emit('joinRoom', {
                rid: 'L' + window.location.href.substr(window.location.href.lastIndexOf('/') + 1)
            });
            //Status Change
            $('.entryCheck').change(function (e) {
                //e.preventDefault(); // prevents page reloading
                var status = 0;
                if (this.checked)
                    status = 1;
                listNsp.emit('checkEntryChange', {
                    id: e.target.getAttribute("value"),
                    st: status
                });
                return false;
            });
            listNsp.on('checkEntryChange', function (msg) {
                var checked = true;
                if (msg.st == 0)
                    checked = false;
                $('#entryCheck' + msg.id).prop('checked', checked);
            });
            listNsp.on('chatMsg', function (msg) {
                var newChat = templateChat(msg);
                $('.chatitems').append(newChat); //TODO fix this
                $('.chatitems').animate({
                    scrollTop: $('.chatitems').prop('scrollHeight')
                }, 500);
            });
            listNsp.on('deleteChatMsg', function (msg) {
                var delChat = $("input[name='deleteChatId'][value='" + msg.deleteChatId + "'").parents(
                    '.chatitem'); //parentus deletus
                delChat.remove();
            });
            globalSkt.on('newsMsg', function (msg) {
                alert('NEWS');
            });
        });
    </script>
    <% include ejs/footerPublic.ejs %>
</body>

</html>